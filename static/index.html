<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>БОГ || OASIS</title>
<style>
  :root {
    --green:  #00FF41;
    --cyan:   #00E5FF;
    --purple: #7B2FFF;
    --bg:     #050505;
    --panel:  #0d0d0d;
    --border: #1a1a1a;
    --text:   #cccccc;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Courier New', monospace;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* ── Header ── */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .logo {
    font-size: 16px;
    font-weight: bold;
    color: var(--green);
    letter-spacing: 2px;
    text-shadow: 0 0 10px rgba(0,255,65,0.5);
  }
  .logo span { color: var(--cyan); }
  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    background: #333;
    display: inline-block;
    margin-right: 6px;
    transition: background 0.3s, box-shadow 0.3s;
  }
  .status-dot.online { background: var(--green); box-shadow: 0 0 6px var(--green); }
  #status-label { font-size: 12px; color: #555; }

  /* ── Mode tabs ── */
  .tabs {
    display: flex;
    gap: 2px;
    padding: 10px 20px 0;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .tab {
    padding: 7px 16px;
    font-size: 12px;
    font-family: inherit;
    background: transparent;
    color: #444;
    border: 1px solid transparent;
    border-bottom: none;
    cursor: pointer;
    letter-spacing: 1px;
    transition: all 0.2s;
  }
  .tab:hover { color: var(--cyan); }
  .tab.active {
    color: var(--cyan);
    border-color: var(--border);
    border-bottom: 1px solid var(--bg);
    background: var(--panel);
    margin-bottom: -1px;
  }

  /* ── Main layout ── */
  .main { display: flex; flex: 1; overflow: hidden; }

  /* ── Chat / results panel ── */
  #output {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  #output::-webkit-scrollbar { width: 4px; }
  #output::-webkit-scrollbar-thumb { background: #222; border-radius: 2px; }

  .msg {
    max-width: 820px;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    animation: fadeIn 0.2s ease;
  }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; } }

  .msg.user {
    align-self: flex-end;
    background: #0f1a0f;
    border: 1px solid #1a2e1a;
    color: var(--green);
  }
  .msg.assistant {
    align-self: flex-start;
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--text);
  }
  .msg.thinking {
    align-self: flex-start;
    background: transparent;
    border: none;
    color: #333;
    font-size: 12px;
    padding: 4px 0;
  }
  .msg.error {
    align-self: flex-start;
    border: 1px solid #3d0000;
    background: #100000;
    color: #ff4444;
  }

  /* Sources */
  .sources {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #1a1a1a;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .source-chip {
    font-size: 11px;
    padding: 3px 8px;
    border: 1px solid var(--purple);
    border-radius: 12px;
    color: var(--purple);
    text-decoration: none;
    transition: all 0.2s;
  }
  .source-chip:hover {
    background: rgba(123,47,255,0.15);
    color: var(--cyan);
    border-color: var(--cyan);
  }

  /* Search results */
  .search-result {
    padding: 10px 14px;
    border-left: 2px solid var(--purple);
    margin-bottom: 8px;
  }
  .search-result a {
    color: var(--cyan);
    font-size: 13px;
    text-decoration: none;
  }
  .search-result a:hover { text-decoration: underline; }
  .search-result .snippet { font-size: 12px; color: #666; margin-top: 4px; }

  /* Side panel (settings) */
  #side {
    width: 220px;
    border-left: 1px solid var(--border);
    padding: 16px;
    overflow-y: auto;
    flex-shrink: 0;
    font-size: 12px;
  }
  .side-section { margin-bottom: 20px; }
  .side-label { color: #444; margin-bottom: 8px; letter-spacing: 1px; font-size: 11px; }
  .param { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
  .param label { color: #666; }
  .param input[type=number] {
    width: 50px;
    background: var(--panel);
    border: 1px solid var(--border);
    color: var(--green);
    padding: 3px 6px;
    font-family: inherit;
    font-size: 12px;
    text-align: right;
  }
  .param input[type=checkbox] { accent-color: var(--green); }

  /* ── Input bar ── */
  .input-bar {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  #query {
    flex: 1;
    background: var(--panel);
    border: 1px solid #1f1f1f;
    color: var(--text);
    font-family: inherit;
    font-size: 13px;
    padding: 10px 14px;
    resize: none;
    outline: none;
    border-radius: 4px;
    max-height: 120px;
    min-height: 42px;
    transition: border-color 0.2s;
  }
  #query:focus { border-color: var(--green); }
  #query::placeholder { color: #2a2a2a; }
  #send-btn {
    background: var(--green);
    color: #000;
    border: none;
    font-family: inherit;
    font-weight: bold;
    font-size: 12px;
    padding: 10px 18px;
    cursor: pointer;
    border-radius: 4px;
    letter-spacing: 1px;
    transition: opacity 0.2s;
    white-space: nowrap;
  }
  #send-btn:hover { opacity: 0.85; }
  #send-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  .shortcut { font-size: 11px; color: #2a2a2a; padding-bottom: 2px; }
</style>
</head>
<body>

<header>
  <div class="logo">БОГ&nbsp;||&nbsp;<span>OASIS</span> <small style="color:#333;font-size:11px;margin-left:8px;">v6.1</small></div>
  <div>
    <span class="status-dot" id="dot"></span>
    <span id="status-label">connecting…</span>
  </div>
</header>

<div class="tabs">
  <button class="tab active" data-mode="think">THINK</button>
  <button class="tab" data-mode="search">SEARCH</button>
  <button class="tab" data-mode="fetch">FETCH</button>
</div>

<div class="main">
  <div id="output">
    <div class="msg assistant">БОГ || OASIS ready. Ask me anything — I'll search the web and think.</div>
  </div>

  <div id="side">
    <div class="side-section">
      <div class="side-label">PARAMS</div>
      <div class="param">
        <label>results n</label>
        <input type="number" id="p-n" value="5" min="1" max="10" />
      </div>
      <div class="param">
        <label>fetch pages</label>
        <input type="number" id="p-fetch" value="1" min="0" max="3" />
      </div>
      <div class="param">
        <label>max tokens</label>
        <input type="number" id="p-tokens" value="2048" min="256" max="8192" step="256" />
      </div>
      <div class="param">
        <label>web search</label>
        <input type="checkbox" id="p-search" checked />
      </div>
    </div>
    <div class="side-section">
      <div class="side-label">STATUS</div>
      <div id="agent-status" style="color:#333;font-size:11px;line-height:1.8;">—</div>
    </div>
  </div>
</div>

<div class="input-bar">
  <textarea id="query" rows="1" placeholder="Ask anything…" autocomplete="off"></textarea>
  <div>
    <button id="send-btn" onclick="send()">RUN ⏎</button>
    <div class="shortcut">Shift+Enter</div>
  </div>
</div>

<script>
let mode = 'think';

// ── Mode tabs ────────────────────────────────────────────────────────────────
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    mode = t.dataset.mode;
    const placeholder = {
      think: 'Ask anything…',
      search: 'Search query…',
      fetch:  'Paste a URL…',
    };
    document.getElementById('query').placeholder = placeholder[mode];
  });
});

// ── Auto-resize textarea ─────────────────────────────────────────────────────
const q = document.getElementById('query');
q.addEventListener('input', () => {
  q.style.height = 'auto';
  q.style.height = Math.min(q.scrollHeight, 120) + 'px';
});
q.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
});

// ── Status check ─────────────────────────────────────────────────────────────
async function checkStatus() {
  try {
    const r = await fetch('/web/status');
    const d = await r.json();
    document.getElementById('dot').className = 'status-dot online';
    document.getElementById('status-label').textContent = 'online';
    document.getElementById('agent-status').innerHTML =
      Object.entries(d).map(([k,v]) => `<b style="color:#444">${k}</b><br>${v}`).join('<br><br>');
  } catch {
    document.getElementById('dot').className = 'status-dot';
    document.getElementById('status-label').textContent = 'offline';
  }
}
checkStatus();
setInterval(checkStatus, 30000);

// ── Output helpers ───────────────────────────────────────────────────────────
function appendMsg(content, cls = 'assistant') {
  const out = document.getElementById('output');
  const el = document.createElement('div');
  el.className = 'msg ' + cls;
  if (typeof content === 'string') el.textContent = content;
  else el.appendChild(content);
  out.appendChild(el);
  out.scrollTop = out.scrollHeight;
  return el;
}

function thinkingEl() {
  return appendMsg('⠋ thinking…', 'thinking');
}

// ── Render search results ────────────────────────────────────────────────────
function renderSearch(results) {
  const wrap = document.createElement('div');
  results.forEach((r, i) => {
    const el = document.createElement('div');
    el.className = 'search-result';
    el.innerHTML = `<a href="${r.url}" target="_blank">[${i+1}] ${r.title || r.url}</a>` +
      (r.snippet ? `<div class="snippet">${r.snippet}</div>` : '');
    wrap.appendChild(el);
  });
  return wrap;
}

// ── Render think response with sources ──────────────────────────────────────
function renderThink(data) {
  const wrap = document.createElement('div');
  const text = document.createElement('div');
  text.textContent = data.response || '(empty response)';
  wrap.appendChild(text);
  if (data.sources && data.sources.length) {
    const src = document.createElement('div');
    src.className = 'sources';
    data.sources.forEach(s => {
      const a = document.createElement('a');
      a.className = 'source-chip';
      a.href = s.url;
      a.target = '_blank';
      a.textContent = `[${s.index}] ${s.title || s.url}`;
      src.appendChild(a);
    });
    wrap.appendChild(src);
  }
  return wrap;
}

// ── Main send ────────────────────────────────────────────────────────────────
async function send() {
  const text = q.value.trim();
  if (!text) return;

  q.value = '';
  q.style.height = 'auto';
  appendMsg(text, 'user');

  const btn = document.getElementById('send-btn');
  btn.disabled = true;
  const spinner = thinkingEl();

  const n       = parseInt(document.getElementById('p-n').value) || 5;
  const fetch_t = parseInt(document.getElementById('p-fetch').value) || 0;
  const tokens  = parseInt(document.getElementById('p-tokens').value) || 2048;
  const search  = document.getElementById('p-search').checked;

  try {
    let resp, data;

    if (mode === 'think') {
      resp = await fetch('/web/think', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ task: text, n, fetch_top: fetch_t, max_tokens: tokens, search }),
      });
      data = await resp.json();
      spinner.remove();
      appendMsg(renderThink(data));

    } else if (mode === 'search') {
      resp = await fetch('/web/search', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ query: text, n, fetch_top: 0 }),
      });
      data = await resp.json();
      spinner.remove();
      appendMsg(renderSearch(data.results));

    } else if (mode === 'fetch') {
      resp = await fetch('/web/fetch', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ url: text, max_chars: 6000 }),
      });
      data = await resp.json();
      spinner.remove();
      if (data.error) {
        appendMsg(`Error: ${data.error}`, 'error');
      } else {
        appendMsg(`── ${data.title}\n\n${data.text}`, 'assistant');
      }
    }

  } catch (err) {
    spinner.remove();
    appendMsg('Connection error — is GodLocal running on :8000?', 'error');
  }

  btn.disabled = false;
  q.focus();
}
</script>
</body>
</html>